#!/bin/sh
# This Script is check Malware for linux base system
# write by zen9ya0 @2021/09/15
# modified for support CentOS 7 && rh 7,8 && debian 11 &&ubuntu 16 @2021/10/04
# Email: solar324yao@gmail.com
#
#
#

PATH="/usr/local/bin:/usr/local/sbin:/bin:/sbin:/usr/bin:/usr/sbin"
HOSTNAME=`hostname`
IP=`ip a|grep "inet\b" |grep -v 127|awk '{print $2}'|awk -F / '{print $1}'`
DATE=`date '+%Y%m%d'`

mkdir /var/tmp/meso_$DATE
#檢查系統登陸日誌，統計IP重試登陸的次數。
last root|grep pts|awk '{print $3}'|sort |uniq -c|sort -nr > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_01.txt

#檢視是否有異常的系統使用者
cat /etc/passwd > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_02-1.txt

#檢查是否有新使用者尤其是UID和GID為0的使用者
cat /etc/passwd| awk  -F ":" '{if($3 == 0){print $1}}' > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_02-2.txt

#ps -ef命令檢視程序
ps -ef > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_03-1.txt

#檢視該程序所開啟的檔案
lsof |awk '{print "PID: "$2" USER: "$3" Port: "$8" FILE: "$9 }' > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_03-2.txt

#檢查隱藏程序
ps -ef | awk '{print $2}'| sort -n | uniq > /var/tmp/1; ls /proc |sort -n|uniq > /var/tmp/2;diff -y -W 40 /var/tmp/1 /var/tmp/2 > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_03-3.txt

#檢查 SUID的檔案
find / -path '/proc' -prune -or -perm -u+s -exec ls -l {} \; > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_04-1.txt

#檢查大於10M的檔案
find / -size +10000k -print > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_04-2.txt

#檢查空格檔案
echo "#...#" > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_04-3.txt
find / -name "...*" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_04-3.txt
echo "#..#" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_04-3.txt
find / -name "..*" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_04-3.txt
echo "#.#" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_04-3.txt
find / -name "\.*" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_04-3.txt
echo "#空白#" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_04-3.txt
find / -name "\ *" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_04-3.txt

#檢查系統中的.core檔
find / -name "*.core" -exec ls -l '{}' \; > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_04-4.txt

#檢查網絡卡模式
ip link > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_06-1.txt

#檢查惡意程式開放的埠及開啟的檔案
netstat -ntlup  > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_06-2.txt
echo "###################" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_06-2.txt
lsof -i  >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_06-2.txt

#檢查系統排程
echo "##crontab –u root –l##" > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_07-1.txt
crontab -u root -l >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_07-1.txt
echo "###################" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_07-1.txt

echo "##cat /etc/crontab##" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_07-1.txt
cat /etc/crontab >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_07-1.txt
echo "###################" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_07-1.txt

echo "##ls /etc/cron.*##" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_07-1.txt
ls /etc/cron.* >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_07-1.txt
echo "###################" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_07-1.txt

#檢查系統服務
echo "##chkconfig —list##" > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_08-1.txt
chkconfig —list >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_08-1.txt
echo "###################" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_08-1.txt
echo "##systemctl list-unit-files##" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_08-1.txt
systemctl list-unit-files >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_08-1.txt
echo "###################" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_08-1.txt

#檢查rootkit
echo "#########chkrootkit##########" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_09-1.txt
#chkrootkit -q > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_09-1.txt
echo "chkrootkit is running ,wait.."
/var/tmp/chkrootkit/chkrootkit > /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_09-1.txt
echo "###################" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_09-1.txt
echo "rkhunter is running ,wait.."
echo "#########rkhunter##########" >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_09-1.txt
rkhunter -c --sk >> /var/tmp/meso_$DATE/${HOSTNAME}_${IP}_09-1.txt

#打包檔案
tar zcf meso_$DATE.tgz /var/tmp/meso_$DATE
echo "This Shell is check OK"
